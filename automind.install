#!/bin/bash
# tested on Ubuntu 22.04.6 LTS
# automind (c) 2023 codephreak MIT license
# this script updates Ubuntu system to current
# checks for conda and updates or installs conda
# actives automind conda environment
# clones automind
# installs automind with default model llama-2-7b-chat-codeCherryPop.ggmlv3.q4_1.bin
# launches boilerplate Gradio instruction response and expose API to localhost and globalhost
# Professor Codephreak is ...

# Add Script Directories to PATH
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

sudo apt-get update
sudo apt-get upgrade -y

# Check if Miniconda is already installed
if ! command -v conda &> /dev/null; then
    # Download and install Miniconda
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    chmod +x Miniconda3-latest-Linux-x86_64.sh
    sudo ./Miniconda3-latest-Linux-x86_64.sh -b -p $HOME/miniconda3
    echo 'export PATH="$HOME/miniconda3/bin:$PATH"' >> ~/.bashrc
    source ~/.bashrc
    # Change ownership of the miniconda3 directory to the user
    sudo chown -R $USER:$USER $HOME/miniconda3
else
    echo "Miniconda is already installed. Updating Conda..."
    conda update -y conda
fi

source ~/.bashrc

# show details of the conda install
conda --version

# Create automind miniconda environment
conda create --name automind python=3.9.1 -y
source ~/.bashrc
# Activate automind miniconda enviroment
conda activate automind
# Display miniconda environment list to terminal output
conda env list

# Detect user's shell setting shell name as a variable
USER_SHELL=$(env | grep SHELL | awk -F'=' '{print $2}')

# Initialize miniconda for the detected shell
echo "Initializing Miniconda for $USER_SHELL..."
conda init $USER_SHELL
source ~/.bashrc

# Install gradio and psutil
pip install gradio psutil fire

# Clone the 'automind' repository and install its requirements
git clone https://github.com/Professor-Codephreak/automind
cd automind
pip install --upgrade pip
pip --version
pip install -r requirements.txt

# Run UIUX
python uiux.py --model_name="TheBloke/llama2-7b-chat-codeCherryPop-qLoRA-GGML" --tokenizer_name="TheBloke/llama2-7b-chat-codeCherryPop-qLoRA-GGML" --model_type="ggml" --save_history --file_name="llama-2-7b-chat-codeCherryPop.ggmlv3.q4_1.bin"

#README currently loads with Bash shell. todo: add shell read to install
#two terminal inputs for deployment make automind.install exectuable and open with bash

#chmod +x automind.install
#./automind.install
